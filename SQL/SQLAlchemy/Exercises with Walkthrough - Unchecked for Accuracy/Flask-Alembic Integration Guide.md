Additional help for: https://appacademy.instructure.com/courses/319/pages/migrations-with-alembic-2?module_item_id=56624
## 1. Initial Setup

### Installation
```bash
# For new projects
pipenv install --python "$PYENV_ROOT/shims/python" \
    Flask-SQLAlchemy alembic Flask-Migrate Flask python-dotenv

# For existing Flask projects
pipenv install alembic Flask-Migrate
```
Flask-Migrate combines Flask-SQLAlchemy with Alembic, making database migrations much easier.

### Project Structure
```plaintext
your_project/
├── app/
│   ├── __init__.py      # Flask app configuration
│   └── models.py        # SQLAlchemy models
├── migrations/          # Created by Flask-Migrate
├── .env                 # Environment variables
└── flask_migrate_test.py  # Flask application entry
```

## 2. Configuration Files

### Environment Variables (.env or .flaskenv)
```plaintext
FLASK_APP=flask_migrate_test.py
FLASK_ENV=development
DATABASE_URL=sqlite:///dev.db
```
These variables configure Flask and database connection.

### Flask App (app/__init__.py)
```python
# app/__init__.py
from app.models import db
from flask import Flask
from flask_migrate import Migrate
import os

app = Flask(__name__)
app.config.from_mapping({
    'SQLALCHEMY_DATABASE_URI': os.environ.get('DATABASE_URL'),
    'SQLALCHEMY_TRACK_MODIFICATIONS': False,
})
db.init_app(app)
Migrate(app, db)
```
This sets up Flask with SQLAlchemy and Flask-Migrate.

### Models (app/models.py)
```python
# app/models.py
from flask_sqlalchemy import SQLAlchemy

db = SQLAlchemy()

class Owner(db.Model):
    __tablename__ = "owners"
    
    id = db.Column(db.Integer, primary_key=True)
    first_name = db.Column(db.String(50), nullable=False)
    last_name = db.Column(db.String(50), nullable=False)
    email = db.Column(db.String(255), nullable=False)
```
Define your models using SQLAlchemy as normal.

### Entry Point (flask_migrate_test.py)
```python
# flask_migrate_test.py
from app import app
```
Simple entry point for Flask.

## 3. Migration Commands

### Initialize Migrations
```bash
# Create migrations directory
pipenv run flask db init
```
This creates the migrations folder with Alembic configuration.

### Generate Migration
```bash
# Create new migration
pipenv run flask db migrate -m "create owners table"
```
Automatically generates migration based on model changes.

### Apply Migration
```bash
# Apply pending migrations
pipenv run flask db upgrade

# Rollback migration
pipenv run flask db downgrade
```
Manages database schema changes.

## 4. Auto-Generated Migrations

### Example Output (migrations/versions/xxxx_create_owners_table.py)
```python
def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('owners',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('first_name', sa.String(length=50), nullable=False),
        sa.Column('last_name', sa.String(length=50), nullable=False),
        sa.Column('email', sa.String(length=255), nullable=False),
        sa.PrimaryKeyConstraint('id')
    )
    # ### end Alembic commands ###

def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('owners')
    # ### end Alembic commands ###
```
Flask-Migrate generates complete migrations from your models.

## 5. Common Workflow

### Adding New Models
```python
# app/models.py
class Pet(db.Model):
    __tablename__ = 'pets'
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100))
    owner_id = db.Column(db.Integer, db.ForeignKey('owners.id'))
```
After adding model:
1. `flask db migrate -m "add pets table"`
2. `flask db upgrade`

## 6. Available Commands
```bash
# Show all commands
pipenv run flask db --help

# Common commands
flask db init      # Initialize migrations
flask db migrate   # Generate migration
flask db upgrade   # Apply migrations
flask db downgrade # Rollback migrations
flask db history   # Show migration history
flask db current   # Show current version
```

## 7. Best Practices

### Migration Management
```python
# Always review auto-generated migrations
def upgrade():
    # Add any manual adjustments needed
    op.create_table(...)
    
    # Add indexes after table creation
    op.create_index(...)
```

### Version Control
```plaintext
# Files to commit:
✓ migrations/versions/  # Migration files
✓ migrations/env.py    # Migration config
✓ migrations/script.py.mako  # Migration template

# Files to ignore:
✗ *.db  # Database files
✗ .env  # Environment variables
```

Remember:
- Always review auto-generated migrations
- Keep migrations in version control
- Test migrations before production
- Use meaningful migration messages
- Follow database changes in order
- Back up database before migrations
- Use environment variables for configuration
